// SPDX-License-Identifier: MIT
pragma solidity ^0.8.27;

import "forge-std/Test.sol";
import "../src/Arbitrage.sol";

contract ArbitrageTest is Test {
    uint256 mainnetFork;
    ArbitrageBot public arbitrageBot;
    // 주소 정보
    address constant TRIGGER = 0xc221b31C31e6e064BBDa9a9C0ED0B955e9837d12;
    address constant RECEIVER = 0x9d45eCAE5277D58aFEDd587C2DB208Ab7BD4c253;
    address constant WETH = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;

    // Block number
    uint256 constant BLOCK_NUMBER = 24040945;
    address constant TARGET_TX_FROM = 0x55B5135C4896bb11D96Ed94aa31e8684bc5B8dFa;
    address constant TARGET_TX_TO = 0x00000047bB99ea4D791bb749D970DE71EE0b1A34;
    uint256 constant VALUE = 0 ether;
    bytes constant TARGET_TX_CALLDATA = hex"d808d889000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055b5135c4896bb11d96ed94aa31e8684bc5b8dfa000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000a968163f0a57b400000000000000000000000000000000000000000000000000000f44010f557ad9ae200000000000000000000000000000000000000000000000821ab0d4414980000000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000003696f73000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055b5135c4896bb11d96ed94aa31e8684bc5b8dfa00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000e592427a0aece92de3edee1f18e0157c058615640000000000000000000000000000000000000000000000000000000000000001000000000000000000000000e592427a0aece92de3edee1f18e0157c05861564000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000284ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000144c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000e592427a0aece92de3edee1f18e0157c058615640000000000000000000000000000000000000000000000000000000069443f0a000000000000000000000000000000000000000000000a8e5fb8e36166a80000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000426b175474e89094c44da98b954eedeac495271d0f000064a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480001f4c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004449404b7c000000000000000000000000000000000000000000000000000000000000000100000000000000000000000055b5135c4896bb11d96ed94aa31e8684bc5b8dfa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"; // 실제 calldata로 교체 필요

    // 트랜잭션 2 정보 (Arbitrage transaction)
    address constant ARB_TX_FROM = TRIGGER;
    bytes constant ARB_TX_CALLDATA = hex"ae16c3570000000000000000000000000000000000000000000000000000000000000040000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000066000000000000000000000000060594a405d53811d3bc4766596efd80fd545a270000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000584128acb080000000000000000000000008aa06bb850ad5c603483a972f1282ef61a0ae893000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000001b04b1f54cd906458900000000000000000000000000000000000000000000000000000001000276a400000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000004c00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000005777d92f208679db4b9778590fa3cab3ac9e21680000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003c4128acb0800000000000000000000000060594a405d53811d3bc4766596efd80fd545a2700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001db5722e000000000000000000000000fffd8963efd1fc6a506488495d951d5263988d2500000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000088e6a0c2ddd26feeb64f039a2c41296fcb3f5640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000204128acb080000000000000000000000005777d92f208679db4b9778590fa3cab3ac9e216800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000273c7946f624d70000000000000000000000000fffd8963efd1fc6a506488495d951d5263988d2500000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb00000000000000000000000088e6a0c2ddd26feeb64f039a2c41296fcb3f56400000000000000000000000000000000000000000000000000273c7946f624d7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0554a476a092703abdb3ef35c80e0d76d32939f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003c4128acb080000000000000000000000008aa06bb850ad5c603483a972f1282ef61a0ae8930000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000016d7243b100000000000000000000000000000000000000000000000000000001000276a400000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000088e6a0c2ddd26feeb64f039a2c41296fcb3f5640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000204128acb08000000000000000000000000e0554a476a092703abdb3ef35c80e0d76d32939f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e2b5cc7f7c14266000000000000000000000000fffd8963efd1fc6a506488495d951d5263988d2500000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb00000000000000000000000088e6a0c2ddd26feeb64f039a2c41296fcb3f56400000000000000000000000000000000000000000000000001e2b5cc7f7c14266000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

    function setUp() public {
        // Block N-1에서 fork (TARGET_TX 실행 전 상태)
        // Foundry는 해당 블록의 모든 트랜잭션 실행 후 상태를 fork
        string memory rpcUrl = string(
            abi.encodePacked(
                "https://eth-mainnet.g.alchemy.com/v2/",
                vm.envString("ALCHEMY_API_KEY")
            )
        );
        mainnetFork = vm.createFork(rpcUrl, BLOCK_NUMBER - 1);
        vm.selectFork(mainnetFork);

        // TRIGGER 주소에 1 ETH 설정 (가스비 충분히 확보)
        vm.deal(TRIGGER, 1 ether);

        // ArbitrageBot 배포 (TRIGGER 주소로)
        vm.prank(TRIGGER);
        arbitrageBot = new ArbitrageBot();

        console.log("===========================================");
        console.log("Forked at block:", BLOCK_NUMBER - 1);
        console.log("Current block.number:", block.number);
        console.log("TRIGGER balance:", TRIGGER.balance / 1 ether, "ETH");
        console.log("TARGET_TX_FROM balance:", TARGET_TX_FROM.balance / 1e18, "ETH");
        console.log("ArbitrageBot deployed at:", address(arbitrageBot));
        console.log("===========================================");
    }

    // wei를 ETH 형식으로 출력 (소수점 18자리)
    function formatEther(uint256 weiAmount) internal pure returns (string memory) {
        uint256 integerPart = weiAmount / 1e18;
        uint256 decimalPart = weiAmount % 1e18;

        // decimalPart를 18자리 문자열로 변환
        bytes memory decimalBytes = new bytes(18);
        for (uint256 i = 18; i > 0; i--) {
            decimalBytes[i - 1] = bytes1(uint8(48 + decimalPart % 10));
            decimalPart /= 10;
        }

        return string(abi.encodePacked(
            vm.toString(integerPart),
            ".",
            string(decimalBytes),
            " ETH"
        ));
    }

    function testSequentialTransactions() public {
        console.log("\n=== Starting Sequential Transaction Test ===\n");

        // 초기 잔액 확인
        uint256 ethBalanceBefore = RECEIVER.balance;
        uint256 wethBalanceBefore = IERC20(WETH).balanceOf(RECEIVER);

        console.log("--- Initial Balances (Profit Recipient) ---");
        console.log("Address:", RECEIVER);
        console.log("ETH Balance:", ethBalanceBefore, "wei =", formatEther(ethBalanceBefore));
        console.log("WETH Balance:", wethBalanceBefore, "wei =", formatEther(wethBalanceBefore));
        console.log("");

        vm.prank(TARGET_TX_FROM);
        (bool success1, bytes memory returnData1) = TARGET_TX_TO.call{value: VALUE}(TARGET_TX_CALLDATA);

        console.log("Transaction 1 success:", success1);
        if (!success1) {
            console.log("Transaction 1 failed:");
        }
        require(success1, "Transaction 1 failed");

        vm.prank(ARB_TX_FROM);
        (bool success2, bytes memory returnData2) = address(arbitrageBot).call(ARB_TX_CALLDATA);

        console.log("Transaction 2 success:", success2);
        if (!success2) {
            console.log("Transaction 2 failed:");
        }
        require(success2, "Transaction 2 failed");

        // 최종 잔액 확인
        uint256 ethBalanceAfter = RECEIVER.balance;
        uint256 wethBalanceAfter = IERC20(WETH).balanceOf(RECEIVER);

        console.log("\n--- Final Balances (Profit Recipient) ---");
        console.log("Address:", RECEIVER);
        console.log("ETH Balance:", ethBalanceAfter, "wei =", formatEther(ethBalanceAfter));
        console.log("WETH Balance:", wethBalanceAfter, "wei =", formatEther(wethBalanceAfter));

        console.log("\n--- Balance Changes ---");
        if (ethBalanceAfter > ethBalanceBefore) {
            uint256 profit = ethBalanceAfter - ethBalanceBefore;
            console.log("ETH Profit:", profit, "wei =", formatEther(profit));
        } else if (ethBalanceAfter < ethBalanceBefore) {
            uint256 loss = ethBalanceBefore - ethBalanceAfter;
            console.log("ETH Loss:", loss, "wei =", formatEther(loss));
        } else {
            console.log("ETH: No change");
        }

        if (wethBalanceAfter > wethBalanceBefore) {
            uint256 profit = wethBalanceAfter - wethBalanceBefore;
            console.log("WETH Profit:", profit, "wei =", formatEther(profit));
        } else if (wethBalanceAfter < wethBalanceBefore) {
            uint256 loss = wethBalanceBefore - wethBalanceAfter;
            console.log("WETH Loss:", loss, "wei =", formatEther(loss));
        } else {
            console.log("WETH: No change");
        }

        console.log("\n=== Test Completed Successfully ===\n");
    }

    function testContractExists() public view {
        // Arbitrage 컨트랙트가 배포되어 있는지 확인
        address botAddress = address(arbitrageBot);
        uint256 codeSize;
        assembly {
            codeSize := extcodesize(botAddress)
        }

        console.log("\n=== Contract Verification ===");
        console.log("Arbitrage contract address:", botAddress);
        console.log("Code size:", codeSize);

        assertTrue(codeSize > 0, "Arbitrage contract not deployed");
    }

    function testGetBytecode() public view {
        console.log("\n=== ArbitrageBot Bytecode ===");
        bytes memory bytecode = address(arbitrageBot).code;
        console.log("Bytecode length:", bytecode.length);
        console.logBytes(bytecode);
    }

    function testTargetContractExists() public view {
        // Target 컨트랙트가 존재하는지 확인
        address targetAddress = TARGET_TX_TO;
        uint256 codeSize;
        assembly {
            codeSize := extcodesize(targetAddress)
        }

        console.log("\n=== Target Contract Verification ===");
        console.log("Target contract address:", targetAddress);
        console.log("Code size:", codeSize);

        assertTrue(codeSize > 0, "Target contract not found");
    }
}
